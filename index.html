<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ZigZag Tracker</title>
    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #6366f1;
            --primary-glow: rgba(99, 102, 241, 0.4);
            --secondary: #10b981;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --font-main: 'Outfit', sans-serif;
            --radius: 16px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-dark);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        /* --- Utilities --- */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card {
            background: var(--bg-card);
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 0 15px var(--primary-glow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            width: 100%;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-secondary {
            background: #334155;
            box-shadow: none;
        }

        .btn-danger {
            background: var(--danger);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.3);
        }

        .btn-icon {
            width: 50px;
            height: 50px;
            padding: 0;
            border-radius: 50%;
        }

        input,
        select,
        textarea {
            width: 100%;
            background: #0f172a;
            border: 1px solid #334155;
            color: white;
            padding: 0.75rem;
            border-radius: 10px;
            margin-bottom: 1rem;
            font-family: inherit;
            font-size: 1rem;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px var(--primary-glow);
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-weight: 500;
        }

        h1,
        h2,
        h3 {
            line-height: 1.2;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 1.8rem;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 2rem;
        }

        /* --- Layout --- */
        nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0 1rem;
            /* Safe area padding */
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.75rem;
            background: none;
            border: none;
            gap: 4px;
            cursor: pointer;
            padding: 0.5rem;
            flex: 1;
        }

        .nav-item i {
            font-size: 1.25rem;
            transition: 0.3s;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .nav-item.active i {
            transform: translateY(-2px);
            text-shadow: 0 0 10px var(--primary-glow);
        }

        .screen {
            display: none;
            padding: 1.5rem;
            padding-bottom: 100px;
            /* Space for nav */
            animation: fadeIn 0.3s ease;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- Components --- */
        .macro-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .macro-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 0.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .macro-val {
            font-weight: 700;
            font-size: 1.1rem;
            color: #fff;
        }

        .macro-lbl {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #334155;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--primary);
        }

        input:checked+.slider:before {
            transform: translateX(22px);
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(99, 102, 241, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        /* Media Previews */
        #img-preview {
            max-width: 100%;
            border-radius: 12px;
            margin-top: 1rem;
            display: none;
        }

        .recording-pulse {
            animation: pulse-red 1.5s infinite;
            color: var(--danger) !important;
        }

        @keyframes pulse-red {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }
    </style>
</head>

<body>

    <!-- Loading Overlay -->
    <div id="loader">
        <div class="spinner"></div>
        <p id="loader-text">AI is analyzing...</p>
    </div>

    <!-- Navigation -->
    <nav>
        <button class="nav-item active" onclick="app.router.go('plan')">
            <i class="fa-solid fa-calendar-check"></i>
            <span>Plan</span>
        </button>
        <button class="nav-item" onclick="app.router.go('track')">
            <i class="fa-solid fa-plus-circle"></i>
            <span>Track</span>
        </button>
        <button class="nav-item" onclick="app.router.go('progress')">
            <i class="fa-solid fa-chart-line"></i>
            <span>Progress</span>
        </button>
        <button class="nav-item" onclick="app.router.go('settings')">
            <i class="fa-solid fa-gear"></i>
            <span>Settings</span>
        </button>
    </nav>

    <!-- Main Content -->
    <main>
        <!-- PROFILE / WELCOME (Force show if no profile) -->
        <section id="screen-profile" class="screen">
            <h1>Setup Profile</h1>
            <p class="subtitle">Let's calculate your personalized plan.</p>

            <div class="card">
                <label>Age</label>
                <input type="number" id="p-age" placeholder="25">

                <label>Sex</label>
                <select id="p-sex">
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                </select>

                <label>Height (cm)</label>
                <input type="number" id="p-height" placeholder="175">

                <label>Current Weight (kg)</label>
                <input type="number" id="p-weight" placeholder="70">

                <label>Goal Weight (kg)</label>
                <input type="number" id="p-goal-weight" placeholder="65">

                <label>Activity Level</label>
                <select id="p-activity">
                    <option value="1.2">Sedentary (Little/no exercise)</option>
                    <option value="1.375">Lightly Active (1-3 days/week)</option>
                    <option value="1.55">Moderately Active (3-5 days/week)</option>
                    <option value="1.725">Very Active (6-7 days/week)</option>
                    <option value="1.9">Extra Active (Physically demanding)</option>
                </select>

                <button class="btn" onclick="app.saveProfile()">Calculate Plan</button>
            </div>
        </section>

        <!-- PLAN SCREEN -->
        <section id="screen-plan" class="screen">
            <h1>Daily Plan</h1>
            <p class="subtitle" id="plan-date">Today</p>

            <!-- Workout Toggle -->
            <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <h3 style="margin:0"><i class="fa-solid fa-dumbbell"
                            style="color:var(--secondary); margin-right:8px;"></i>Workout Day?</h3>
                    <p style="font-size:0.8rem; color:var(--text-muted); margin-top:4px;">Increases calorie target</p>
                </div>
                <label class="switch">
                    <input type="checkbox" id="toggle-workout" onchange="app.toggleWorkoutDay(this.checked)">
                    <span class="slider"></span>
                </label>
            </div>

            <!-- Targets -->
            <div class="card glass" style="text-align:center;">
                <h2 id="target-cals" style="font-size:3rem; margin:0; color:var(--primary);">2000</h2>
                <p style="color:var(--text-muted); margin-bottom:1rem;">Target Calories</p>

                <div class="macro-grid">
                    <div class="macro-card">
                        <div class="macro-val">
                            <span id="consumed-pro" style="color:var(--secondary)">0</span> / <span
                                id="target-pro">150</span>g
                        </div>
                        <div class="macro-lbl">Protein</div>
                        <div
                            style="background:#334155; height:4px; border-radius:2px; margin-top:4px; overflow:hidden;">
                            <div id="bar-pro"
                                style="width:0%; height:100%; background:var(--secondary); transition:width 0.5s;">
                            </div>
                        </div>
                    </div>
                    <div class="macro-card">
                        <div class="macro-val">
                            <span id="consumed-carb" style="color:var(--secondary)">0</span> / <span
                                id="target-carb">200</span>g
                        </div>
                        <div class="macro-lbl">Carbs</div>
                        <div
                            style="background:#334155; height:4px; border-radius:2px; margin-top:4px; overflow:hidden;">
                            <div id="bar-carb"
                                style="width:0%; height:100%; background:var(--secondary); transition:width 0.5s;">
                            </div>
                        </div>
                    </div>
                    <div class="macro-card">
                        <div class="macro-val">
                            <span id="consumed-fat" style="color:var(--secondary)">0</span> / <span
                                id="target-fat">60</span>g
                        </div>
                        <div class="macro-lbl">Fat</div>
                        <div
                            style="background:#334155; height:4px; border-radius:2px; margin-top:4px; overflow:hidden;">
                            <div id="bar-fat"
                                style="width:0%; height:100%; background:var(--secondary); transition:width 0.5s;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Summary -->
            <div class="card">
                <h3>Consumed</h3>
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <span style="font-size:2rem; font-weight:700;" id="consumed-cals">0</span>
                    <span style="color:var(--text-muted); margin-bottom:6px;"> / <span
                            id="summary-target-cals">2000</span> kcal</span>
                </div>
                <!-- Simple progress bar -->
                <div style="background:#334155; height:6px; border-radius:3px; margin-top:8px; overflow:hidden;">
                    <div id="consumed-bar"
                        style="background:var(--secondary); height:100%; width:0%; transition:width 0.5s;"></div>
                </div>
            </div>
        </section>

        <!-- TRACK SCREEN -->
        <section id="screen-track" class="screen">
            <h1>Track Meal</h1>
            <p class="subtitle">Log manually or use Gemini AI</p>

            <div class="card">
                <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:0.5rem; margin-bottom:1rem;">
                    <button class="btn btn-secondary" onclick="app.trackMode('text')" id="mode-text"><i
                            class="fa-solid fa-keyboard"></i></button>
                    <button class="btn btn-secondary" onclick="app.trackMode('camera')" id="mode-camera"><i
                            class="fa-solid fa-camera"></i></button>
                    <button class="btn btn-secondary" onclick="app.trackMode('mic')" id="mode-mic"><i
                            class="fa-solid fa-microphone"></i></button>
                </div>

                <!-- Text Input -->
                <div id="input-text-area">
                    <label>Describe your meal</label>
                    <textarea id="meal-desc" rows="3"
                        placeholder="A bowl of oatmeal with banana and honey..."></textarea>
                </div>

                <!-- Camera Input -->
                <div id="input-camera-area" style="display:none; text-align:center;">
                    <input type="file" id="meal-photo" accept="image/*" capture="environment" style="display:none"
                        onchange="app.handleImage(this)">
                    <button class="btn" onclick="document.getElementById('meal-photo').click()"
                        style="margin-bottom:1rem;">
                        Take Photo / Upload
                    </button>
                    <img id="img-preview">
                </div>

                <!-- Mic Input -->
                <div id="input-mic-area" style="display:none; text-align:center; padding:1rem;">
                    <p style="margin-bottom:1rem; color:var(--text-muted);">Tab button to record description</p>
                    <button class="btn btn-icon" id="record-btn" onmousedown="app.startRecord()"
                        onmouseup="app.stopRecord()" ontouchstart="app.startRecord()" ontouchend="app.stopRecord()">
                        <i class="fa-solid fa-microphone"></i>
                    </button>
                    <p id="record-status" style="margin-top:1rem; font-size:0.8rem;">Hold to record</p>
                </div>

                <button class="btn" style="margin-top:1rem;" onclick="app.analyzeMeal()">
                    <i class="fa-solid fa-wand-magic-sparkles"></i> Analyze with AI
                </button>
            </div>

            <div class="card" id="manual-entry-form">
                <h3>Results / Manual Entry</h3>
                <label>Food Name</label>
                <input type="text" id="m-name">

                <div class="macro-grid" style="margin-bottom:1rem;">
                    <div>
                        <label>Cals</label>
                        <input type="number" id="m-cals">
                    </div>
                    <div>
                        <label>Pro (g)</label>
                        <input type="number" id="m-pro">
                    </div>
                    <div>
                        <label>Carb (g)</label>
                        <input type="number" id="m-carb">
                    </div>
                    <div>
                        <label>Fat (g)</label>
                        <input type="number" id="m-fat">
                    </div>
                </div>

                <!-- AI Extras -->
                <div id="ai-extras"
                    style="display:none; border-top:1px solid #334155; padding-top:1rem; margin-top:1rem;">
                    <p id="warn-allergen" style="color:var(--danger); display:none; margin-bottom:0.5rem;"><i
                            class="fa-solid fa-triangle-exclamation"></i> Allergen Detected: <span
                            id="allergen-names"></span></p>
                    <p id="info-gi" style="color:var(--text-muted); display:none; font-size:0.9rem;">Glycemic Index:
                        <span id="val-gi" style="color:#fff;"></span>
                    </p>
                    <p id="info-insulin" style="color:var(--text-muted); display:none; font-size:0.9rem;">Est. Insulin:
                        <span id="val-insulin" style="color:#fff;"></span> units (Not Medical Advice)
                    </p>
                </div>

                <button class="btn" style="background:var(--secondary);" onclick="app.saveMeal()">
                    <i class="fa-solid fa-check"></i> Save to Log
                </button>
            </div>
        </section>

        <!-- PROGRESS SCREEN -->
        <section id="screen-progress" class="screen">
            <h1>Progress</h1>
            <p class="subtitle">Your journey so far.</p>

            <div class="card">
                <h3>Weight Log</h3>
                <div style="display:flex; gap:0.5rem; margin-bottom:1rem;">
                    <input type="number" id="new-weight" placeholder="Kg">
                    <button class="btn" style="width:auto;" onclick="app.logWeight()"><i
                            class="fa-solid fa-plus"></i></button>
                </div>
                <div style="height:250px; margin-bottom:1.5rem;">
                    <canvas id="weightChart"></canvas>
                </div>

                <h4>Weight History</h4>
                <div id="weight-history-list" style="max-height:300px; overflow-y:auto; margin-bottom:1rem;">
                    <!-- Weights go here -->
                </div>
                <div style="display:flex; justify-content:center; gap:1rem;">
                    <button class="btn btn-secondary" onclick="app.weightPage(false)"
                        style="width:auto; padding:0.4rem 1rem;"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="weight-page-num"
                        style="align-self:center; color:var(--text-muted); font-size:0.9rem;">1</span>
                    <button class="btn btn-secondary" onclick="app.weightPage(true)"
                        style="width:auto; padding:0.4rem 1rem;"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>

            <div class="card">
                <h3>Meal History</h3>
                <button class="btn btn-secondary" style="font-size:0.8rem; padding:0.5rem; margin-bottom:1rem;"
                    onclick="app.clearHistory()">Clear All Data</button>
                <div id="history-list" style="max-height:400px; overflow-y:auto; margin-bottom:1rem;">
                    <!-- Items go here -->
                </div>
                <div style="display:flex; justify-content:center; gap:1rem;">
                    <button class="btn btn-secondary" onclick="app.mealPage(false)"
                        style="width:auto; padding:0.4rem 1rem;"><i class="fa-solid fa-chevron-left"></i></button>
                    <span id="meal-page-num"
                        style="align-self:center; color:var(--text-muted); font-size:0.9rem;">1</span>
                    <button class="btn btn-secondary" onclick="app.mealPage(true)"
                        style="width:auto; padding:0.4rem 1rem;"><i class="fa-solid fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

        <!-- EDIT MODAL -->
        <div id="edit-modal"
            style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:150; align-items:center; justify-content:center;">
            <div class="card" style="width:90%; max-width:400px; max-height:90vh; overflow-y:auto;">
                <h2 id="modal-title">Edit Entry</h2>
                <div id="modal-content"></div>
                <div style="display:flex; gap:1rem; margin-top:1rem;">
                    <button class="btn btn-secondary" onclick="app.closeModal()">Cancel</button>
                    <button class="btn" id="modal-save-btn">Save</button>
                </div>
            </div>
        </div>

        <!-- SETTINGS SCREEN -->
        <section id="screen-settings" class="screen">
            <h1>Settings</h1>

            <div class="card">
                <h3>API Key & Model</h3>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:0.5rem;">Required for AI features.
                    Stored locally.</p>
                <input type="password" id="s-api-key" placeholder="Paste key here..." style="margin-bottom:0.5rem;">

                <label>AI Model</label>
                <select id="s-model" onchange="app.saveSettings()">
                    <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash Exp</option>
                    <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                    <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
                    <option value="gemini-2.5-pro">Gemini 2.5 Pro</option>
                    <option value="gemini-3-flash-preview">Gemini 3 Flash Preview</option>
                    <option value="gemini-3-pro-preview">Gemini 3 Pro Preview</option>
                </select>

                <button class="btn btn-secondary" onclick="app.saveSettings()">Save Settings</button>
            </div>

            <div class="card">
                <h3>Preferences</h3>
                <button class="btn btn-secondary" onclick="app.router.go('profile')" style="margin-bottom:1rem;">Edit
                    Profile</button>

                <div class="setting-row">
                    <label style="margin:0">Show Macros</label>
                    <label class="switch">
                        <input type="checkbox" id="s-show-macros" onchange="app.saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="setting-row">
                    <label style="margin:0">Show Glycemic Index</label>
                    <label class="switch">
                        <input type="checkbox" id="s-show-gi" onchange="app.saveSettings()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>

            <div class="card">
                <h3>Health Features</h3>

                <div class="setting-row">
                    <label style="margin:0">Diabetic Mode</label>
                    <label class="switch">
                        <input type="checkbox" id="s-diabetic" onchange="app.toggleDiabetic(this.checked)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="diabetic-settings" style="display:none;">
                    <label>Insulin Ratio (1 unit per Xg carbs)</label>
                    <input type="number" id="s-insulin-ratio" placeholder="e.g. 10" onchange="app.saveSettings()">

                    <div class="setting-row">
                        <label style="margin:0">Show Est. Insulin</label>
                        <label class="switch">
                            <input type="checkbox" id="s-show-insulin" onchange="app.saveSettings()">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>

                <label style="margin-top:1rem;">Allergens (Comma separated)</label>
                <input type="text" id="s-allergens" placeholder="Peanuts, Shellfish..." onchange="app.saveSettings()">
            </div>
        </section>

    </main>

    <script>
        const app = {
            data: {
                profile: null,
                logs: [],
                weightHistory: [],
                settings: {
                    apiKey: '',
                    model: 'gemini-1.5-flash',
                    showMacros: true,
                    showGI: false,
                    diabeticMode: false,
                    insulinRatio: 10,
                    showInsulin: false,
                    allergens: ''
                },
                todayWorkout: false
            },

            // Paging State
            state: {
                mealPage: 1,
                weightPage: 1,
                pageSize: 10,
                editingId: null,
                editingType: null // 'meal' or 'weight'
            },

            init() {
                this.load();
                this.router.init();

                if (!this.data.profile) {
                    this.router.go('profile');
                    // Hide nav if no profile
                    document.querySelector('nav').style.display = 'none';
                } else {
                    this.renderPlan();
                    this.renderHistory();
                    this.updateCharts();
                }

                this.bindInputs();
            },

            save() {
                localStorage.setItem('mealApp', JSON.stringify(this.data));
            },

            load() {
                const stored = localStorage.getItem('mealApp');
                if (stored) {
                    this.data = { ...this.data, ...JSON.parse(stored) };
                    // Restore UI state from settings
                    document.getElementById('s-api-key').value = this.data.settings.apiKey;
                    document.getElementById('s-model').value = this.data.settings.model || 'gemini-1.5-flash';
                    document.getElementById('s-show-macros').checked = this.data.settings.showMacros;
                    document.getElementById('s-show-gi').checked = this.data.settings.showGI;
                    document.getElementById('s-diabetic').checked = this.data.settings.diabeticMode;
                    document.getElementById('s-insulin-ratio').value = this.data.settings.insulinRatio;
                    document.getElementById('s-show-insulin').checked = this.data.settings.showInsulin;
                    document.getElementById('s-allergens').value = this.data.settings.allergens;

                    this.toggleDiabetic(this.data.settings.diabeticMode);

                    document.getElementById('toggle-workout').checked = this.data.todayWorkout;

                    // Ensure defaults if missing (migrations)
                    if (!this.data.weightHistory) this.data.weightHistory = [];

                    // Profile/Nav logic
                    if (this.data.profile) {
                        document.getElementById('p-age').value = this.data.profile.age;
                        document.getElementById('p-sex').value = this.data.profile.sex;
                        document.getElementById('p-height').value = this.data.profile.height;
                        document.getElementById('p-weight').value = this.data.profile.weight;
                        document.getElementById('p-goal-weight').value = this.data.profile.goalWeight;
                        document.getElementById('p-activity').value = this.data.profile.activity;
                        document.querySelector('nav').style.display = 'flex';
                    }
                }
            },

            // --- ROUTER ---
            router: {
                go(screenId) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    document.getElementById('screen-' + screenId).classList.add('active');

                    document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
                    // Highlight nav
                    const navBtns = document.querySelectorAll('.nav-item');
                    if (screenId === 'plan') navBtns[0].classList.add('active');
                    if (screenId === 'track') navBtns[1].classList.add('active');
                    if (screenId === 'progress') {
                        navBtns[2].classList.add('active');
                        app.updateCharts();
                        app.renderWeightHistory();
                    }
                    if (screenId === 'settings') navBtns[3].classList.add('active');
                },
                init() {
                    // default to plan if profile exists
                }
            },

            // --- PROFILE & PLAN ---
            saveProfile() {
                const profile = {
                    age: Number(document.getElementById('p-age').value),
                    sex: document.getElementById('p-sex').value,
                    height: Number(document.getElementById('p-height').value),
                    weight: Number(document.getElementById('p-weight').value),
                    goalWeight: Number(document.getElementById('p-goal-weight').value),
                    activity: Number(document.getElementById('p-activity').value)
                };

                if (!profile.age || !profile.height || !profile.weight) return alert('Please fill all fields');

                this.data.profile = profile;
                this.save();
                this.renderPlan();
                document.querySelector('nav').style.display = 'flex';
                this.router.go('plan');
            },

            calculateTargets() {
                if (!this.data.profile) return { cals: 2000, pro: 150, carb: 200, fat: 60 };

                const { age, sex, height, weight, activity } = this.data.profile;

                // Mifflin-St Jeor Equation
                let bmr = (10 * weight) + (6.25 * height) - (5 * age);
                bmr += sex === 'male' ? 5 : -161;

                let tdee = bmr * activity;

                // Goal adjustment (defecit for weight loss)
                // ZigZag Logic: 
                // Workout Day: TDEE (Maintenance) or slight surplus
                // Rest Day: TDEE - 500 (Deficit) 
                // Simplified for this requirement:
                // Base Goal is TDEE - 500.
                // Workout Day adds back 300-400 cals.

                const baseGoal = tdee - 500;
                let targetCals = this.data.todayWorkout ? (baseGoal + 400) : baseGoal;

                // Macro split (40/30/30)
                const pro = (targetCals * 0.35) / 4;
                const fat = (targetCals * 0.25) / 9;
                const carb = (targetCals * 0.40) / 4;

                return {
                    cals: Math.round(targetCals),
                    pro: Math.round(pro),
                    carb: Math.round(carb),
                    fat: Math.round(fat)
                };
            },

            renderPlan() {
                const targets = this.calculateTargets();
                document.getElementById('target-cals').innerText = targets.cals;
                document.getElementById('target-pro').innerText = targets.pro;
                document.getElementById('target-carb').innerText = targets.carb;
                document.getElementById('target-fat').innerText = targets.fat;
                document.getElementById('summary-target-cals').innerText = targets.cals;

                // Calc consumed today
                const today = new Date().toDateString();
                const todaysLogs = this.data.logs.filter(l => new Date(l.date).toDateString() === today);

                const consumed = {
                    cals: todaysLogs.reduce((acc, l) => acc + (Number(l.cals) || 0), 0),
                    pro: todaysLogs.reduce((acc, l) => acc + (Number(l.pro) || 0), 0),
                    carb: todaysLogs.reduce((acc, l) => acc + (Number(l.carb) || 0), 0),
                    fat: todaysLogs.reduce((acc, l) => acc + (Number(l.fat) || 0), 0)
                };

                document.getElementById('consumed-cals').innerText = consumed.cals;

                // Update specific macros
                document.getElementById('consumed-pro').innerText = consumed.pro;
                document.getElementById('consumed-carb').innerText = consumed.carb;
                document.getElementById('consumed-fat').innerText = consumed.fat;

                // Progress Bars
                const pctCals = Math.min((consumed.cals / targets.cals) * 100, 100);
                document.getElementById('consumed-bar').style.width = pctCals + '%';
                if (consumed.cals > targets.cals) document.getElementById('consumed-bar').style.background = 'var(--danger)';
                else document.getElementById('consumed-bar').style.background = 'var(--secondary)';

                const pctPro = Math.min((consumed.pro / targets.pro) * 100, 100);
                document.getElementById('bar-pro').style.width = pctPro + '%';

                const pctCarb = Math.min((consumed.carb / targets.carb) * 100, 100);
                document.getElementById('bar-carb').style.width = pctCarb + '%';

                const pctFat = Math.min((consumed.fat / targets.fat) * 100, 100);
                document.getElementById('bar-fat').style.width = pctFat + '%';
            },

            toggleWorkoutDay(isWorkout) {
                this.data.todayWorkout = isWorkout;
                this.save();
                this.renderPlan();
            },

            // --- TRACKING UI ---
            trackMode(mode) {
                document.getElementById('input-text-area').style.display = 'none';
                document.getElementById('input-camera-area').style.display = 'none';
                document.getElementById('input-mic-area').style.display = 'none';

                document.getElementById('m-name').value = '';
                document.getElementById('m-cals').value = '';
                document.getElementById('m-pro').value = '';
                document.getElementById('m-carb').value = '';
                document.getElementById('m-fat').value = '';
                document.getElementById('ai-extras').style.display = 'none';
                document.getElementById('img-preview').style.display = 'none';

                if (mode === 'text') document.getElementById('input-text-area').style.display = 'block';
                if (mode === 'camera') document.getElementById('input-camera-area').style.display = 'block';
                if (mode === 'mic') document.getElementById('input-mic-area').style.display = 'block';
            },

            handleImage(input) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const img = document.getElementById('img-preview');
                        img.src = e.target.result;
                        img.style.display = 'block';
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            // --- AUDIO RECORDER ---
            mediaRecorder: null,
            audioChunks: [],

            async startRecord() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    this.mediaRecorder = new MediaRecorder(stream);
                    this.audioChunks = [];
                    this.mediaRecorder.addEventListener("dataavailable", event => {
                        this.audioChunks.push(event.data);
                    });
                    this.mediaRecorder.start();
                    document.getElementById('record-btn').classList.add('recording-pulse');
                    document.getElementById('record-status').innerText = 'Recording... Release to analyze.';
                } catch (err) {
                    alert('Microphone access denied. Note: Browsers may block microphone on local files (file://). Try using a local server (localhost).');
                    console.error(err);
                }
            },

            stopRecord() {
                if (this.mediaRecorder && this.mediaRecorder.state !== 'inactive') {
                    this.mediaRecorder.stop();
                    document.getElementById('record-btn').classList.remove('recording-pulse');
                    document.getElementById('record-status').innerText = 'Processing Audio...';

                    this.mediaRecorder.onstop = async () => {
                        const mimeType = this.mediaRecorder.mimeType || 'audio/webm';
                        const audioBlob = new Blob(this.audioChunks, { type: mimeType });

                        const reader = new FileReader();
                        reader.readAsDataURL(audioBlob);
                        reader.onloadend = () => {
                            const base64data = reader.result.split(',')[1];
                            this.callGeminiAudio(base64data, mimeType);
                        }
                    };
                }
            },


            // --- AI INTEGRATION ---
            async analyzeMeal() {
                const text = document.getElementById('meal-desc').value;
                const imgInput = document.getElementById('meal-photo');

                // Determine mode by visibility
                const textVisible = document.getElementById('input-text-area').style.display !== 'none';
                const camVisible = document.getElementById('input-camera-area').style.display !== 'none';

                if (textVisible && text) {
                    this.callGeminiText(text);
                } else if (camVisible && imgInput.files[0]) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        this.callGeminiImage(base64, imgInput.files[0].type);
                    }
                    reader.readAsDataURL(imgInput.files[0]);
                }
            },

            async callGeminiText(text) {
                this.showLoader(true);
                const prompt = `Analyze this meal description: "${text}". Return JSON only: { "name": "Short Name", "calories": int, "protein": int, "carbs": int, "fat": int, "gi": int (estimated), "allergens": ["detected match from user list ${this.data.settings.allergens} or empty"] }`;
                await this.fetchGemini(prompt);
            },

            async callGeminiImage(base64, mimeType) {
                this.showLoader(true);
                const prompt = `Analyze this image of food. Return JSON only: { "name": "Short Name", "calories": int, "protein": int, "carbs": int, "fat": int, "gi": int, "allergens": [] }`;
                // Construct multipart/image payload
                await this.fetchGemini(prompt, { inlineData: { mimeType: mimeType, data: base64 } });
            },

            async callGeminiAudio(base64, mimeType) {
                this.showLoader(true);
                const prompt = `Listen to this food description. Return JSON only: { "name": "Short Name", "calories": int, "protein": int, "carbs": int, "fat": int, "gi": int, "allergens": [] }`;
                await this.fetchGemini(prompt, { inlineData: { mimeType: mimeType, data: base64 } });
            },

            async fetchGemini(textMeta, parts = null) {
                const key = this.data.settings.apiKey;
                const model = this.data.settings.model || 'gemini-1.5-flash';
                if (!key) {
                    this.showLoader(false);
                    return alert('Please save your Google Gemini API Key in Settings first.');
                }

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

                const contentParts = [{ text: textMeta }];
                if (parts) contentParts.push(parts);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: contentParts }]
                        })
                    });

                    const data = await response.json();
                    this.showLoader(false);

                    if (data.error) throw new Error(data.error.message);

                    const rawText = data.candidates[0].content.parts[0].text;
                    const jsonStr = rawText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const result = JSON.parse(jsonStr);

                    this.populateResults(result);

                } catch (e) {
                    this.showLoader(false);
                    console.error(e);
                    alert('AI Error: ' + e.message);
                }
            },

            populateResults(data) {
                document.getElementById('m-name').value = data.name || 'Unknown';
                document.getElementById('m-cals').value = data.calories || 0;
                document.getElementById('m-pro').value = data.protein || 0;
                document.getElementById('m-carb').value = data.carbs || 0;
                document.getElementById('m-fat').value = data.fat || 0;

                // Extras
                const extras = document.getElementById('ai-extras');
                extras.style.display = 'block';

                if (this.data.settings.showGI) {
                    document.getElementById('info-gi').style.display = 'block';
                    document.getElementById('val-gi').innerText = data.gi || '?';
                }

                // Allergens
                const userAllergens = this.data.settings.allergens.toLowerCase().split(',').map(s => s.trim()).filter(s => s);
                // Simple strict match check if AI returned allergen list or if we check name
                // To be robust, let's assume AI detected strictly
                if (data.allergens && data.allergens.length > 0) {
                    document.getElementById('warn-allergen').style.display = 'block';
                    document.getElementById('allergen-names').innerText = data.allergens.join(', ');
                } else {
                    document.getElementById('warn-allergen').style.display = 'none';
                }

                // Insulin
                if (this.data.settings.diabeticMode && this.data.settings.showInsulin && this.data.settings.insulinRatio) {
                    document.getElementById('info-insulin').style.display = 'block';
                    const units = (data.carbs || 0) / this.data.settings.insulinRatio;
                    document.getElementById('val-insulin').innerText = units.toFixed(1);
                }
            },

            showLoader(show) {
                document.getElementById('loader').style.display = show ? 'flex' : 'none';
            },

            // --- SAVE & HISTORY ---
            saveMeal() {
                const meal = {
                    id: Date.now(),
                    date: new Date().toISOString(),
                    name: document.getElementById('m-name').value,
                    cals: Number(document.getElementById('m-cals').value),
                    pro: Number(document.getElementById('m-pro').value),
                    carb: Number(document.getElementById('m-carb').value),
                    fat: Number(document.getElementById('m-fat').value)
                };

                if (!meal.name) return alert('Enter a name');

                this.data.logs.push(meal);
                this.save();
                this.renderHistory();
                this.renderPlan(); // Update totals

                // Clear inputs
                document.getElementById('m-name').value = '';
                document.getElementById('m-cals').value = '';
                document.getElementById('m-pro').value = '';
                document.getElementById('m-carb').value = '';
                document.getElementById('m-fat').value = '';

                alert('Meal Logged!');
            },

            renderHistory() {
                const list = document.getElementById('history-list');
                list.innerHTML = '';
                // Sort by date desc
                const sorted = [...this.data.logs].sort((a, b) => b.id - a.id);

                // Paging
                const start = (this.state.mealPage - 1) * this.state.pageSize;
                const paged = sorted.slice(start, start + this.state.pageSize);

                document.getElementById('meal-page-num').innerText = `${this.state.mealPage} / ${Math.ceil(sorted.length / this.state.pageSize) || 1}`;

                paged.forEach(log => {
                    const row = document.createElement('div');
                    row.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:0.8rem; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem;";
                    row.innerHTML = `
                        <div>
                            <div style="font-weight:600; color:#fff;">${log.name}</div>
                            <div style="color:var(--text-muted); font-size:0.8rem;">
                                ${new Date(log.date).toLocaleDateString()} ${new Date(log.date).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
                            </div>
                        </div>
                        <div style="text-align:right; display:flex; align-items:center; gap:0.5rem;">
                            <div style="color:var(--secondary); font-weight:700;">${log.cals} kcal</div>
                            <button onclick="app.editMeal(${log.id})" style="background:#334155; border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-pen"></i></button>
                            <button onclick="app.deleteLog(${log.id})" style="background:#ef4444; border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(row);
                });
            },

            mealPage(next) {
                const total = Math.ceil(this.data.logs.length / this.state.pageSize) || 1;
                if (next && this.state.mealPage < total) this.state.mealPage++;
                if (!next && this.state.mealPage > 1) this.state.mealPage--;
                this.renderHistory();
            },

            editMeal(id) {
                const log = this.data.logs.find(l => l.id === id);
                if (!log) return;

                this.state.editingId = id;
                this.state.editingType = 'meal';

                const html = `
                    <label>Name</label><input id="edit-name" value="${log.name}">
                    <div class="macro-grid">
                        <div><label>Cals</label><input type="number" id="edit-cals" value="${log.cals}"></div>
                        <div><label>Pro</label><input type="number" id="edit-pro" value="${log.pro}"></div>
                        <div><label>Carb</label><input type="number" id="edit-carb" value="${log.carb}"></div>
                        <div><label>Fat</label><input type="number" id="edit-fat" value="${log.fat}"></div>
                    </div>
                `;

                document.getElementById('modal-title').innerText = 'Edit Meal';
                document.getElementById('modal-content').innerHTML = html;
                document.getElementById('edit-modal').style.display = 'flex';
                document.getElementById('modal-save-btn').onclick = () => app.saveEdit();
            },

            deleteLog(id) {
                if (!confirm('Delete this entry?')) return;
                this.data.logs = this.data.logs.filter(l => l.id !== id);
                this.save();
                this.renderHistory();
                this.renderPlan();
            },

            // --- WEIGHT HISTORY ---
            renderWeightHistory() {
                const list = document.getElementById('weight-history-list');
                list.innerHTML = '';
                const sorted = [...this.data.weightHistory].sort((a, b) => new Date(b.date) - new Date(a.date));

                const start = (this.state.weightPage - 1) * this.state.pageSize;
                const paged = sorted.slice(start, start + this.state.pageSize);

                document.getElementById('weight-page-num').innerText = `${this.state.weightPage} / ${Math.ceil(sorted.length / this.state.pageSize) || 1}`;

                paged.forEach((w, idx) => {
                    // We use original index or timestamp as ID. Let's use timestamp `w.date` as unique ID roughly
                    const row = document.createElement('div');
                    row.style.cssText = "display:flex; justify-content:space-between; align-items:center; padding:0.8rem; border-bottom:1px solid rgba(255,255,255,0.05); font-size:0.9rem;";
                    row.innerHTML = `
                         <div>
                            <div style="font-weight:600; color:#fff;">${w.weight} kg</div>
                            <div style="color:var(--text-muted); font-size:0.8rem;">${new Date(w.date).toLocaleDateString()}</div>
                        </div>
                        <div>
                             <button onclick="app.editWeight('${w.date}')" style="background:#334155; border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-pen"></i></button>
                             <button onclick="app.deleteWeight('${w.date}')" style="background:#ef4444; border:none; color:white; padding:4px 8px; border-radius:4px; cursor:pointer;"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    `;
                    list.appendChild(row);
                });
            },

            weightPage(next) {
                const total = Math.ceil(this.data.weightHistory.length / this.state.pageSize) || 1;
                if (next && this.state.weightPage < total) this.state.weightPage++;
                if (!next && this.state.weightPage > 1) this.state.weightPage--;
                this.renderWeightHistory();
            },

            editWeight(dateStr) {
                const w = this.data.weightHistory.find(x => x.date === dateStr);
                if (!w) return;

                this.state.editingId = dateStr;
                this.state.editingType = 'weight';

                const html = `
                    <label>Weight (kg)</label><input type="number" id="edit-weight-val" value="${w.weight}">
                    <label>Date</label><input type="datetime-local" id="edit-weight-date" value="${new Date(dateStr).toISOString().slice(0, 16)}">
                `;
                document.getElementById('modal-title').innerText = 'Edit Weight';
                document.getElementById('modal-content').innerHTML = html;
                document.getElementById('edit-modal').style.display = 'flex';
                document.getElementById('modal-save-btn').onclick = () => app.saveEdit();
            },

            deleteWeight(dateStr) {
                if (!confirm('Delete this weight entry?')) return;
                this.data.weightHistory = this.data.weightHistory.filter(w => w.date !== dateStr);
                this.save();
                this.updateCharts();
                this.renderWeightHistory();
            },

            // --- MODAL & SAVING ---
            closeModal() {
                document.getElementById('edit-modal').style.display = 'none';
                this.state.editingId = null;
                this.state.editingType = null;
            },

            saveEdit() {
                if (this.state.editingType === 'meal') {
                    const log = this.data.logs.find(l => l.id === this.state.editingId);
                    if (log) {
                        log.name = document.getElementById('edit-name').value;
                        log.cals = Number(document.getElementById('edit-cals').value);
                        log.pro = Number(document.getElementById('edit-pro').value);
                        log.carb = Number(document.getElementById('edit-carb').value);
                        log.fat = Number(document.getElementById('edit-fat').value);
                        this.save();
                        this.renderHistory();
                        this.renderPlan();
                    }
                } else if (this.state.editingType === 'weight') {
                    const w = this.data.weightHistory.find(x => x.date === this.state.editingId);
                    if (w) {
                        w.weight = Number(document.getElementById('edit-weight-val').value);
                        const newDate = new Date(document.getElementById('edit-weight-date').value).toISOString();
                        w.date = newDate;
                        this.save();
                        this.updateCharts();
                        this.renderWeightHistory();
                    }
                }
                this.closeModal();
            },

            clearHistory() {
                if (!confirm('Clear ALL meal logs?')) return;
                this.data.logs = [];
                this.save();
                this.renderHistory();
                this.renderPlan();
            },

            // --- PROGRESS ---
            logWeight() {
                const w = Number(document.getElementById('new-weight').value);
                if (!w) return;
                this.data.weightHistory.push({ date: new Date().toISOString(), weight: w });

                // Update profile weight too
                this.data.profile.weight = w;

                this.save();
                this.updateCharts();
                this.renderWeightHistory();
                document.getElementById('new-weight').value = '';
            },

            updateCharts() {
                const ctx = document.getElementById('weightChart').getContext('2d');

                // Prepare data
                const labels = this.data.weightHistory.map(w => new Date(w.date).toLocaleDateString());
                const dataPoints = this.data.weightHistory.map(w => w.weight);

                if (window.myWaitChart) window.myWaitChart.destroy();

                window.myWaitChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Weight (kg)',
                            data: dataPoints,
                            borderColor: '#6366f1',
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                            x: { grid: { color: 'rgba(255,255,255,0.05)' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            },

            // --- SETTINGS ---
            saveSettings() {
                this.data.settings.apiKey = document.getElementById('s-api-key').value;
                this.data.settings.model = document.getElementById('s-model').value;
                this.data.settings.showMacros = document.getElementById('s-show-macros').checked;
                this.data.settings.showGI = document.getElementById('s-show-gi').checked;
                this.data.settings.insulinRatio = Number(document.getElementById('s-insulin-ratio').value);
                this.data.settings.showInsulin = document.getElementById('s-show-insulin').checked;
                this.data.settings.allergens = document.getElementById('s-allergens').value;

                this.save();
                alert('Settings Saved');
            },

            toggleDiabetic(checked) {
                this.data.settings.diabeticMode = checked;
                document.getElementById('diabetic-settings').style.display = checked ? 'block' : 'none';
                this.save();
            },

            bindInputs() {
                // Attach real-time listeners if needed
            }
        };

        // Start
        window.addEventListener('DOMContentLoaded', () => app.init());

    </script>
</body>

</html>